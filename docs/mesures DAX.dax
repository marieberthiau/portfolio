DEFINE
    MEASURE 'MesuresNum'[Flux total] = SUM('comptage-velo-donnees-compteurs-allege'[comptage_horaire])
    MEASURE 'MesuresNum'[Flux de la veille] = CALCULATE([Flux total], DATEADD('Calendrier'[Date], -1, DAY)) --- c'est faux
    MEASURE 'MesuresNum'[Variation J/J-1 (%)] = DIVIDE([Flux total] - [Flux de la veille], [Flux de la veille]) -- faux aussi
    MEASURE 'MesuresNum'[Fux moyen sur 7 jours glissants] = AVERAGEX(
    DATESINPERIOD('Calendrier'[Date], MAX('Calendrier'[Date]), -7, DAY),
    [Flux total]
)
    MEASURE 'MesuresNum'[Temp√©rature Moyenne (¬∞C)] = AVERAGE('meteo'[Temp√©rature Moyenne (¬∞C)])
    MEASURE 'MesuresNum'[Vent moyen (km/h)] = AVERAGE('meteo'[Vent Moyen (km/h)])
    MEASURE 'MesuresNum'[Flux moyen] = AVERAGE('comptage-velo-donnees-compteurs-allege'[comptage_horaire])
    MEASURE 'MesuresNum'[Amplitude Thermique] = VAR TX = SELECTEDVALUE(Meteo[Temp√©rature Max (¬∞C)])
VAR TN = SELECTEDVALUE(Meteo[Temp√©rature Mini (¬∞C)])
RETURN
IF( ISBLANK(TX) || ISBLANK(TN), BLANK(), TX - TN )
    MEASURE 'MesuresNum'[Note globale de m√©t√©o] = VAR TM = [Temp√©rature Moyenne (¬∞C)]
VAR TMin = [Temp√©rature Mini (¬∞C)]
VAR TMax = [Temp√©rature Max (¬∞C)]
VAR Amplitude = [Amplitude Thermique]
VAR Vent = [Vent moyen (km/h)]
VAR Rafale = [Rafale Max (km/h)]
VAR Pluie = [Niveau Pluie moyen]

-- progression plus punitive sur les fortes chaleur qui en ville sont un facteur limitant, 
VAR ScoreTempMoyenne =    
    SWITCH(
        TRUE(),
        TM < 5, MAX(10, TM * 2),                    -- soit un score de 4 √† 2¬∞C
        TM >= 5 && TM < 10, 18 + (TM - 5) * 2,      -- soit un score de 16 √† 6¬∞C
        TM >= 10 && TM < 15, 28 + (TM - 10) * 2.4,  -- soit un score de 25,6 √† 11¬∞C
        TM >= 15 && TM <= 22, 40,                   -- plage de score max √† 40        
        TM > 22 && TM <= 27, 40 - (TM - 22) * 2,  -- soit un score de 38 √† 23¬∞C        
        TM > 27 && TM <= 30, 30 - (TM - 27) * 3,    -- soit un score de 27 √† 28¬∞C
        TM > 30 && TM <= 35, 18 - (TM - 30) * 3,  -- soit un score de 15 √† 31¬∞C
        TM > 35, MAX(0, 3 - (TM - 35) * 0.6),       -- soit un score de 2,4 √† 36¬∞C  et 0 √† 40¬∞C (puis devient n√©gatif)
        10
    )

VAR PenaliteFroid =
    SWITCH(
        TRUE(),
        TMin < -5, 5,
        TMin < 0, 3,
        TMin < 5, 1,
        0
    )

VAR PenaliteChaud =
    SWITCH(
        TRUE(),
        TMax > 35, 5,
        TMax > 32, 3,
        TMax > 28, 1,
        0
    )

VAR PenaliteAmplitude =   --L'amplitude thermique influence le confort (forte amplitude = plus difficile de s'habiller correctement)
    SWITCH(
        TRUE(),
        Amplitude > 18, 3,
        Amplitude > 14, 2,
        Amplitude > 10, 1,
        0
    )
-- pour un trajet matin/soir, on subit potentiellement les 2 extr√™mes de temp√©rature et pas la moyenne
VAR ScoreTemp = ROUND(ScoreTempMoyenne - PenaliteFroid - PenaliteChaud - PenaliteAmplitude ,0) 

VAR ScorePluie =
    SWITCH(
        TRUE(),
        Pluie = 0, 40,
        Pluie <= 2, 25,
        Pluie <= 5, 15,
        Pluie <= 10, 5,
        0
    )

VAR ScoreVent =
    SWITCH(
        TRUE(),
        Vent < 10, 15,
        Vent > 30, 0,
        15 - (Vent-10) * 0.75  -- r√©gression lin√©aire entre 10 et 30 km/h
    )
VAR ScoreRafale =
    SWITCH(
        TRUE(),
        Rafale < 30, 5,
        Rafale > 70, 0,
        5 - (Rafale-30) * 0.125  -- r√©gression lin√©aire entre 30 et 70 km/h
    )
RETURN
ScoreTemp + ScorePluie + Round(ScoreVent + ScoreRafale,0)
    MEASURE 'MesuresNum'[Niveau Pluie moyen] = VAR RR = SUM(meteo[Pr√©cipitations (mm)])
VAR DRR = SUM(meteo[Dur√©e Pluie (min)])
VAR DRR_Heures = DIVIDE(DRR, 60, 0)
RETURN RR + DRR_Heures / 2
    MEASURE 'MesuresNum'[Temp√©rature Mini (¬∞C)] = MIN('meteo'[Temp√©rature Mini (¬∞C)])
    MEASURE 'MesuresNum'[Temp√©rature Max (¬∞C)] = MAX('meteo'[Temp√©rature Max (¬∞C)])
    MEASURE 'MesuresNum'[Rafale Max (km/h)] = MAX('meteo'[Rafale Max (km/h)])
    MEASURE 'MesuresNum'[Effet Pluie] = VAR FluxMoyenSec = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Cat Pluie] = "temps sec",
        KEEPFILTERS( meteo[Cat Pluie] = "temps sec" ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
VAR FluxMoyenPluie = 
    CALCULATE(
        [Flux moyen],
        KEEPFILTERS( meteo[Cat Pluie] <> "temps sec" ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
RETURN
    IF(
        ISBLANK(FluxMoyenSec),
        BLANK(),
        DIVIDE( FluxMoyenPluie - FluxMoyenSec, FluxMoyenSec, 0)
    )
    MEASURE 'MesuresNum'[Effet Pluie de R√©f√©rence] = VAR FluxMoyenSec = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Cat Pluie] = "temps sec",
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
VAR FluxMoyenPluie = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Cat Pluie] <> "temps sec",
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
RETURN
    DIVIDE(FluxMoyenPluie - FluxMoyenSec, FluxMoyenSec, 0)
    MEASURE 'MesuresNum'[Sensibilit√© √† la pluie (points de %)] = VAR BaisseContextuelle = [Effet Pluie]
VAR BaisseReference = [Effet Pluie de R√©f√©rence]
RETURN
    (BaisseContextuelle - BaisseReference) * 100
    MEASURE 'MesuresNum'[Nb Jours Secs] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),       -- on limite aux dates o√π il y a du comptage
    meteo[Cat Pluie] = "temps sec",       -- on filtre les jours secs
    REMOVEFILTERS(meteo)                  -- on emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Nb Jours Pluvieux] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),  -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),
    meteo[Cat Pluie] <> "temps sec",
    REMOVEFILTERS(meteo)  --emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Volatilite Trafic] = VAR FluxMoyenSite = [Flux moyen]
VAR FluxMoyenRef = 
    CALCULATE(
        [Flux moyen],
        ALL('comptage-velo-donnees-compteurs-allege')
    )
RETURN
    ABS(DIVIDE(FluxMoyenSite - FluxMoyenRef, FluxMoyenRef, 0))
    MEASURE 'MesuresNum'[Effet M√©t√©o] = VAR FluxMoyenExc = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score M√©t√©o] >=80,  -- 80 correspond au seuil de conditions qualifi√©es d'Excellentes
        KEEPFILTERS( 'meteo'[Score M√©t√©o] >=80 ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
VAR FluxMoyenAut = 
    CALCULATE(
        [Flux moyen],
        KEEPFILTERS( 'meteo'[Score M√©t√©o] <80 ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
RETURN
    IF(
        ISBLANK(FluxMoyenExc),
        BLANK(),
        DIVIDE( FluxMoyenAut - FluxMoyenExc, FluxMoyenExc, 0)
    )
    MEASURE 'MesuresNum'[Effet M√©t√©o de R√©f√©rence] = VAR FluxMoyenExc = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score M√©t√©o] >=80,
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
VAR FluxMoyenAut = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score M√©t√©o] <80,
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
RETURN
    DIVIDE(FluxMoyenAut - FluxMoyenExc, FluxMoyenExc, 0)
    MEASURE 'MesuresNum'[Sensibilit√© √† la m√©t√©o (points de %)] = VAR BaisseContextuelle = [Effet M√©t√©o]
VAR BaisseReference = [Effet M√©t√©o de R√©f√©rence]
RETURN
    (BaisseContextuelle - BaisseReference) * 100
    MEASURE 'MesuresNum'[Effet Vent] = VAR FluxMoyenExc = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score Vent] >=18,   -- en dessous de 10 km/h, le score de vent est au max √† 15 points pour le vent moyen + 5 points si absence de rafale 
        KEEPFILTERS( 'meteo'[Score Vent] >=18 ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
VAR FluxMoyenAut = 
    CALCULATE(
        [Flux moyen],
        KEEPFILTERS( 'meteo'[Score Vent] <18 ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
RETURN
    IF(
        ISBLANK(FluxMoyenExc),
        BLANK(),
        DIVIDE( FluxMoyenAut - FluxMoyenExc, FluxMoyenExc, 0)
    )
    MEASURE 'MesuresNum'[Effet Vent de R√©f√©rence] = VAR FluxMoyenExc = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score Vent] >=18,
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
VAR FluxMoyenAut = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score Vent] <18,
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
RETURN
    DIVIDE(FluxMoyenAut - FluxMoyenExc, FluxMoyenExc, 0)
    MEASURE 'MesuresNum'[Sensibilit√© au vent (points de %)] = VAR BaisseContextuelle = [Effet Vent]
VAR BaisseReference = [Effet Vent de R√©f√©rence]
RETURN
    (BaisseContextuelle - BaisseReference) * 100
    MEASURE 'MesuresNum'[Effet Temp√©rature de R√©f√©rence] = VAR FluxMoyenExc = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score Temp√©rature] >=39,  -- le seuil √† 39/40 permet de retenir 127 jours/395 ce qui est suffisant pour servir de r√©f√©rence
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
VAR FluxMoyenAut = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score Temp√©rature] <39,
        ALL('comptage-velo-donnees-compteurs-allege'), -- enel√®ve les filtres sur la table de faits (p√©riode, compteur...)
        ALL('Calendrier')
    )
RETURN
    DIVIDE(FluxMoyenAut - FluxMoyenExc, FluxMoyenExc, 0)
    MEASURE 'MesuresNum'[Effet Temp√©rature] = VAR FluxMoyenExc = 
    CALCULATE(
        [Flux moyen],
        'meteo'[Score Temp√©rature] >=39,  -- le seuil √† 39/40 permet de retenir 127 jours/395 ce qui est suffisant pour servir de r√©f√©rence
        KEEPFILTERS( 'meteo'[Score Temp√©rature] >=39 ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
VAR FluxMoyenAut = 
    CALCULATE(
        [Flux moyen],
        KEEPFILTERS( 'meteo'[Score Temp√©rature] < 39 ),
        'comptage-velo-donnees-compteurs-allege'[comptage_horaire] >= 0 
    )
RETURN
    IF(
        ISBLANK(FluxMoyenExc),
        BLANK(),
        DIVIDE( FluxMoyenAut - FluxMoyenExc, FluxMoyenExc, 0)
    )
    MEASURE 'MesuresNum'[Sensibilit√© √† la temp√©rature (points de %)] = VAR BaisseContextuelle = [Effet Temp√©rature]
VAR BaisseReference = [Effet Temp√©rature de R√©f√©rence]
RETURN
    (BaisseContextuelle - BaisseReference) * 100
    MEASURE 'MesuresNum'[Nb Jours Excellents] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),       -- on limite aux dates o√π il y a du comptage
    meteo[Score M√©t√©o] >=80,       -- on filtre les jours excellents
    REMOVEFILTERS(meteo)                  -- on emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Nb Jours Non Excellents] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),       -- on limite aux dates o√π il y a du comptage
    meteo[Score M√©t√©o] <80,       -- on filtre les jours excellents
    REMOVEFILTERS(meteo)                  -- on emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Nb Jours Agr√©ables] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),       -- on limite aux dates o√π il y a du comptage
    meteo[Score Temp√©rature] >=39,       -- on filtre les jours excellents
    REMOVEFILTERS(meteo)                  -- on emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Nb Jours Moins Agr√©ables] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),       -- on limite aux dates o√π il y a du comptage
    meteo[Score Temp√©rature] <39,       -- on filtre les jours excellents
    REMOVEFILTERS(meteo)                  -- on emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Nb Jours Calmes] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),       -- on limite aux dates o√π il y a du comptage
    meteo[Score Vent] >=18,       -- on filtre les jours excellents
    REMOVEFILTERS(meteo)                  -- on emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Nb Jours Venteux] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
RETURN
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage),       -- on limite aux dates o√π il y a du comptage
    meteo[Score Vent] <18,       -- on filtre les jours excellents
    REMOVEFILTERS(meteo)                  -- on emp√™che le contexte des lignes d‚Äô√©craser le filtre m√©t√©o
)
    MEASURE 'MesuresNum'[Effet observ√©] = SWITCH(
        TRUE(),
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la pluie (points de %)]",[Effet Pluie],
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© au vent (points de %)]",[Effet Vent],
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la temp√©rature (points de %)]",[Effet Temp√©rature],
        [Effet M√©t√©o]
    )
    MEASURE 'MesuresNum'[Effet de r√©f√©rence] = SWITCH(
        TRUE(),
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la pluie (points de %)]",[Effet Pluie de R√©f√©rence],
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© au vent (points de %)]",[Effet Vent de R√©f√©rence],
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la temp√©rature (points de %)]",[Effet Temp√©rature de R√©f√©rence],
        [Effet M√©t√©o de R√©f√©rence]
    )
    MEASURE 'MesuresNum'[NbJours] = SWITCH(
        TRUE(),
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la pluie (points de %)]",MIN([Nb Jours Secs], [Nb Jours Pluvieux]),
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© au vent (points de %)]",MIN([Nb Jours Calmes], [Nb Jours Venteux]),
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la temp√©rature (points de %)]",MIN([Nb Jours Agr√©ables], [Nb Jours Moins Agr√©ables]),
        MIN([Nb Jours Excellents], [Nb Jours Non Excellents])
    )
    MEASURE 'MesuresNum'[Pr√©cipitations totales] = sum(meteo[Pr√©cipitations (mm)])
    MEASURE 'MesuresNum'[Dur√©e de pluie] = sum(meteo[Dur√©e Pluie (min)])
    MEASURE 'MesuresNum'[Flux max] = CALCULATE(
    MAX('comptage-velo-donnees-compteurs-allege'[comptage_horaire]),
    KEEPFILTERS( VALUES('Calendrier'[Date]) )
)
    MEASURE 'MesuresNum'[Nb Jours au-dessus du Seuil] = VAR SeuilUtilisateur = SELECTEDVALUE('Seuil Flux Journalier'[Seuil Flux Journalier], 3000)
VAR TableJours = 
    SUMMARIZE(
       'Calendrier',
        'Calendrier'[Date],
        "FluxJour", [Flux total]
    )
VAR NbJoursAuDessus = 
    COUNTROWS(
        FILTER(
            TableJours,
            [FluxJour] > SeuilUtilisateur
        )
    )
RETURN
    NbJoursAuDessus
    MEASURE 'MesuresNum'[Nb Jours Moyen au-dessus du Seuil] = VAR SeuilUtilisateur = SELECTEDVALUE('Seuil Flux Journalier'[Seuil Flux Journalier], 3000)
VAR TableSitesJours = 
    SUMMARIZE(
        'comptage-velo-donnees-compteurs-allege',
        'comptage-velo-donnees-compteurs-allege'[id_site],  
        'Calendrier'[Date],
        "FluxJour", [Flux total]
    )
VAR TableParSite = 
    ADDCOLUMNS(
        VALUES('comptage-velo-donnees-compteurs-allege'[id_site]),
        "@NbJoursAuDessus",
            VAR SiteActuel = 'comptage-velo-donnees-compteurs-allege'[id_site]
            RETURN
                COUNTROWS(
                    FILTER(
                        FILTER(
                            TableSitesJours,
                            'comptage-velo-donnees-compteurs-allege'[id_site] = SiteActuel
                        ),
                        [FluxJour] > SeuilUtilisateur
                    )
                )
    )
VAR NbJoursMoyen = AVERAGEX(TableParSite, [@NbJoursAuDessus])
RETURN
    NbJoursMoyen
    MEASURE 'MesuresNum'[% Jours au-dessus du Seuil] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
VAR NbJoursPeriode = 
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage))       -- on limite aux dates o√π il y a du comptage
VAR NbJoursMoyenAuDessus = [Nb Jours Moyen au-dessus du Seuil]
RETURN
    DIVIDE(NbJoursMoyenAuDessus, NbJoursPeriode, 0)
    MEASURE 'MesuresNum'[Card Analyse Seuil] = VAR Seuil = SELECTEDVALUE('Seuil Flux Journalier'[Seuil Flux Journalier], 3000)
VAR NbJoursMoyen = [Nb Jours Moyen au-dessus du Seuil]
VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
VAR NbJoursPeriode = 
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage))       -- on limite aux dates o√π il y a du comptage
VAR Pct = [% Jours au-dessus du Seuil]
VAR NbSites = DISTINCTCOUNT('comptage-velo-donnees-compteurs-allege'[id_site])
RETURN
    FORMAT(NbJoursMoyen, "0") & " jours au dessus / " & NbJoursPeriode & UNICHAR(10) &
    "Soit: " & FORMAT(Pct, "0%") & " des jours" & UNICHAR(10) &
    "(moy sur " & NbSites & " sites)"
    MEASURE 'MesuresNum'[Flux journalier moyen] = VAR DatesAvecComptage =
    FILTER(
        VALUES( Calendrier[Date] ),   -- on it√®re sur les dates r√©elles (=contexte calendrier)
        CALCULATE(
            COUNTROWS( 'comptage-velo-donnees-compteurs-allege' ),  -- on v√©rifie qu'il existe au moins une ligne de comptage pour cette date,
            REMOVEFILTERS( 'compteurs_velo' )                       -- en ignorant les filtres sur la table des compteurs (site/compteur)
        ) > 0
    )
VAR NbJoursPeriode = 
CALCULATE(
    DISTINCTCOUNT(Calendrier[Date]),
    KEEPFILTERS(DatesAvecComptage))       -- on limite aux dates o√π il y a du comptage
VAR FluxTotalJournalier =
CALCULATE(
    SUM('comptage-velo-donnees-compteurs-allege'[comptage_horaire]),
    KEEPFILTERS( VALUES('Calendrier'[Date]) )
)
RETURN
DIVIDE(FluxTotalJournalier,NbJoursPeriode,0)
    MEASURE 'MesuresCat'[Cat Amplitude] = VAR Amp = [Amplitude Thermique]
RETURN
SWITCH(
    TRUE(),
    ISBLANK(Amp), "Donn√©e manquante",
    Amp < 5, "Faible (<5¬∞C)",
    Amp < 10, "Mod√©r√©e (5-10¬∞C)",
    Amp < 15, "Importante (10-15¬∞C)",
    "Tr√®s importante (>15¬∞C)"
)
    MEASURE 'MesuresCat'[Cat Pluie] = VAR NP = [Niveau Pluie moyen]
RETURN
SWITCH(
    TRUE(),
    ISBLANK(NP), "Donn√©e manquante",
    NP = 0, "temps sec",
    NP <= 1, "bruine",                                  -- 0,5 mm en 30 min OU 1 mm tr√®s bri√®vement
    NP <= 3, "pluie faible",                            -- 2 mm en 1h OU 3 mm bri√®vement
    NP <= 7, "pluie mod√©r√©e : √©quipement n√©cessaire",   -- 5 mm pendant 1h = conditions humides s√©rieuses
    NP <= 12, "pluie forte : conditions difficiles",     -- 10 mm pendant 2h = vraiment d√©tremp√©
    "pluie dangereuse : cyclisme d√©conseill√©"           -- 15 mm pendant 3h = conditions extr√™mes
)
    MEASURE 'MesuresCat'[Cat Rafale] = VAR Vent = AVERAGE('meteo'[Rafale Max (km/h)])
RETURN
SWITCH(
    TRUE(),
    ISBLANK(Vent), "Donn√©e manquante",
    Vent < 25, "Rafales n√©gligeables (<25 km/h)",
    Vent < 45, "Rafales mod√©r√©es un peu g√™nantes (25-45 km/h",
    Vent < 70, "Rafales fortes dangereuses (45-70 km/h)",
    "Rafales tr√®s dangereuses (>70 km/h)"
)
    MEASURE 'MesuresCat'[Cat Vent] = VAR Vent = [Vent moyen (km/h)]
VAR Rafale = [Rafale Max (km/h)]
RETURN
SWITCH(
    TRUE(),
    Vent >= 40 || Rafale >= 75 || (Vent >= 30 && Rafale >= 65), "temp√™tueux cyclisme d√©conseill√©",
    Vent >= 30 || Rafale >= 60 || (Vent >= 25 && Rafale >= 55), "tr√®s fort et dangereux",
    Vent >= 20 || Rafale >= 50, "p√©nible mais praticable",
    Vent >= 15 || Rafale >= 40, "mod√©r√© mais commence √† g√™ner",
    Vent >= 10 || Rafale >= 30, "l√©ger mais acceptable",
    "calme id√©al"
    )
    MEASURE 'MesuresCat'[Cat√©gorie Temp√©rature] = VAR TM = [Temp√©rature Moyenne (¬∞C)]
VAR TMin = [Temp√©rature Mini (¬∞C)]
VAR TMax = [Temp√©rature Max (¬∞C)]

VAR Categorie =
    SWITCH(
        TRUE(),
        TMin < -2 || TM < 3, "froid extr√™me",
        TMin < 5 || TM < 10, "froid mais g√©rable",
        TM >= 10 && TM < 15, "frais",
        TM >= 15 && TM <= 25 && TMax <= 28, "doux",
        (TM > 22 && TM <= 28) || (TMax > 28 && TMax <= 32), "chaud",
        TM > 28 || TMax > 32, "tr√®s chaud",
        
        "autre"
    )

RETURN Categorie
    MEASURE 'MesuresCat'[Conditions Globales] = VAR SM = [Note globale de m√©t√©o]
RETURN
SWITCH(
    TRUE(),
    ISBLANK(SM), "inconnues",
    SM >=80, "excellentes",
    SM >=60, "bonnes",
    SM >=40, "acceptables",
    SM >=20, "difficiles",
    "tr√®s difficiles"
)
    MEASURE 'MesuresCat'[Significativit√©] = VAR RatioSite = [Effet observ√©]+1
VAR RatioRef =  [Effet de r√©f√©rence]+1
VAR EcartRatio = ABS(RatioSite - RatioRef)

VAR NbJours = [NbJours]
VAR SeuilSignificativite = 
    SWITCH(
        TRUE(),
        NbJours >= 50, 0.05,  // Seuil 5% pour grands √©chantillons
        NbJours >= 30, 0.08,  // Seuil 8% pour √©chantillons moyens
        NbJours >= 10, 0.12,  // Seuil 12% pour petits √©chantillons
        0.20                  // Seuil 20% pour tr√®s petits √©chantillons
    )
VAR SeuilTexte = FORMAT(SeuilSignificativite, "0 pt")
RETURN
    IF(
        EcartRatio > SeuilSignificativite && NbJours >= 10,   -- par exemple pour une p√©riode > 50j, si j'ai plus de 5 points d'√©carts entre l'effet pluie de r√©f√©rence et l'effet pluie c'est significatif
        "‚úì Significatif (seuil >=" & SeuilTexte & ")",
        "Non significatif (seuil <" & SeuilTexte & ")"
    )
    MEASURE 'MesuresCat'[Axe d'analyse] = VALUES('Mesure s√©lectionn√©e'[Mesure s√©lectionn√©e Fields])
    MEASURE 'MesuresCat'[Libell√© mesure s√©lectionn√©e] = SWITCH(
        TRUE(),
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la pluie (points de %)]","Sensibilit√© √† la pluie üåßÔ∏è",
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© au vent (points de %)]","Sensibilit√© au vent üå¨Ô∏è",
        [Axe d'analyse]="'MesuresNum'[Sensibilit√© √† la temp√©rature (points de %)]","Sensibilit√© √† la temp√©rature üå°Ô∏è",
        "Sensibilit√© √† la m√©t√©o ‚õÖ"  
    )
    MEASURE 'MesuresCat'[Site le + sensible] = VAR TableSites = 
    ADDCOLUMNS(
        VALUES(compteurs_velo[Site de comptage]), 
        "@Sensibilite", [Axe d'analyse]
    )   // Remplace par le nom de ta colonne site
VAR SiteMin = 
    MINX(
        TableSites,
        [@Sensibilite]
    )
VAR NomSite = 
    MAXX(
        FILTER(
            TableSites,
            [@Sensibilite] = SiteMin
        ),
        compteurs_velo[Site de comptage]
    )
RETURN
    NomSite
    MEASURE 'MesuresCat'[Cat√©gorie Seuil] = VAR SeuilUtilisateur = SELECTEDVALUE('Seuil Flux Journalier'[Seuil Flux Journalier], 3000)
VAR FluxSite = [Flux total]
RETURN
    IF(
        FluxSite >= SeuilUtilisateur,
        ">="&FORMAT(SeuilUtilisateur,"#,0"),
        "<"&FORMAT(SeuilUtilisateur,"#,0")
    )
    MEASURE 'Seuil Flux Journalier'[Seuil Flux Journalier Value] = SELECTEDVALUE('Seuil Flux Journalier'[Seuil Flux Journalier], 3000)

EVALUATE
    SUMMARIZECOLUMNS(
        "Flux total", [Flux total],
        "Flux de la veille", [Flux de la veille],
        "Variation J/J-1 (%)", [Variation J/J-1 (%)],
        "Fux moyen sur 7 jours glissants", [Fux moyen sur 7 jours glissants],
        "Temp√©rature Moyenne (¬∞C)", [Temp√©rature Moyenne (¬∞C)],
        "Vent moyen (km/h)", [Vent moyen (km/h)],
        "Flux moyen", [Flux moyen],
        "Amplitude Thermique", [Amplitude Thermique],
        "Note globale de m√©t√©o", [Note globale de m√©t√©o],
        "Niveau Pluie moyen", [Niveau Pluie moyen],
        "Temp√©rature Mini (¬∞C)", [Temp√©rature Mini (¬∞C)],
        "Temp√©rature Max (¬∞C)", [Temp√©rature Max (¬∞C)],
        "Rafale Max (km/h)", [Rafale Max (km/h)],
        "Effet Pluie", [Effet Pluie],
        "Effet Pluie de R√©f√©rence", [Effet Pluie de R√©f√©rence],
        "Sensibilit√© √† la pluie (points de %)", [Sensibilit√© √† la pluie (points de %)],
        "Nb Jours Secs", [Nb Jours Secs],
        "Nb Jours Pluvieux", [Nb Jours Pluvieux],
        "Volatilite Trafic", [Volatilite Trafic],
        "Effet M√©t√©o", [Effet M√©t√©o],
        "Effet M√©t√©o de R√©f√©rence", [Effet M√©t√©o de R√©f√©rence],
        "Sensibilit√© √† la m√©t√©o (points de %)", [Sensibilit√© √† la m√©t√©o (points de %)],
        "Effet Vent", [Effet Vent],
        "Effet Vent de R√©f√©rence", [Effet Vent de R√©f√©rence],
        "Sensibilit√© au vent (points de %)", [Sensibilit√© au vent (points de %)],
        "Effet Temp√©rature de R√©f√©rence", [Effet Temp√©rature de R√©f√©rence],
        "Effet Temp√©rature", [Effet Temp√©rature],
        "Sensibilit√© √† la temp√©rature (points de %)", [Sensibilit√© √† la temp√©rature (points de %)],
        "Nb Jours Excellents", [Nb Jours Excellents],
        "Nb Jours Non Excellents", [Nb Jours Non Excellents],
        "Nb Jours Agr√©ables", [Nb Jours Agr√©ables],
        "Nb Jours Moins Agr√©ables", [Nb Jours Moins Agr√©ables],
        "Nb Jours Calmes", [Nb Jours Calmes],
        "Nb Jours Venteux", [Nb Jours Venteux],
        "Effet observ√©", [Effet observ√©],
        "Effet de r√©f√©rence", [Effet de r√©f√©rence],
        "NbJours", [NbJours],
        "Pr√©cipitations totales", [Pr√©cipitations totales],
        "Dur√©e de pluie", [Dur√©e de pluie],
        "Flux max", [Flux max],
        "Nb Jours au-dessus du Seuil", [Nb Jours au-dessus du Seuil],
        "Nb Jours Moyen au-dessus du Seuil", [Nb Jours Moyen au-dessus du Seuil],
        "% Jours au-dessus du Seuil", [% Jours au-dessus du Seuil],
        "Card Analyse Seuil", [Card Analyse Seuil],
        "Flux journalier moyen", [Flux journalier moyen],
        "Cat Amplitude", [Cat Amplitude],
        "Cat Pluie", [Cat Pluie],
        "Cat Rafale", [Cat Rafale],
        "Cat Vent", [Cat Vent],
        "Cat√©gorie Temp√©rature", [Cat√©gorie Temp√©rature],
        "Conditions Globales", [Conditions Globales],
        "Significativit√©", [Significativit√©],
        "Axe d'analyse", [Axe d'analyse],
        "Libell√© mesure s√©lectionn√©e", [Libell√© mesure s√©lectionn√©e],
        "Site le + sensible", [Site le + sensible],
        "Cat√©gorie Seuil", [Cat√©gorie Seuil],
        "Seuil Flux Journalier Value", [Seuil Flux Journalier Value]
    )